# Overview

This is a Terraform module that creates CI/CD pipelines for planning, testing and applying Terraform configuration against AWS.

- Creates a Terraform CodePipeline to orchestrate the deployment from a long-lived branch (e.g. `develop`, `master`) 
- Each AWS CodePipeline stage invokes AWS CodeBuild projects.
- Artifacts are managed via AWS CodePipeline via S3
- Stages include: Pulling the source code, Testing (`terraform validate` and `terraform fmt`), Building (`terraform plan -out plan`), Approvals, and Applying (`terraform apply`).
- Some example IAM roles and policies to make this example work.

![AWS CI_CD for Terraform - Page 2 (1)](https://user-images.githubusercontent.com/1071270/100020446-dc16b580-2dad-11eb-9287-458097bf3661.png)

## What?

In the end, it allows you to create a CI/CD pipeline for Terraform configuration using AWS CodeBuild and CodePipeline. It allows you to configure the CI/CD pipeline to a long-lived branch such as `main` or `develop`.

An approver has to manually look at the Terraform plan from the **Plan** stage. They do this by going to the previous Stage and looking at the build output. Once inspected, they can approve and the plan will be applied.

![image](https://user-images.githubusercontent.com/1071270/100021080-e71e1580-2dae-11eb-8c74-4821764d48ff.png)

## How?

The AWS CodePipeline orchestrates the process. It uses stages to invoke CodeBuild to perform the actions. 
Each CodeBuild stage has a `buildspec` YAML template to go along with it. 

For example, 

``` yaml
version: 0.2

phases:

  install:
    commands:
      - # commands to install Terraform
  pre_build:
    commands:
      - terraform init -backend=false

  build:
    commands:
      - terraform fmt -check -recursive -no-color
      - terraform validate

  post_build:
    commands:
      - echo terraform validate completed on `date`
```

### The Terraform Plan

It is stored in S3 and managed by CodePipeline.

For example, the Terraform Plan stage would include a `buildspec.yaml` like this:
``` yaml
phases:

  install:
    commands:
      - # commands to install Terraform
  pre_build:
    commands:
      - terraform init

  build:
    commands:
      - terraform plan -out "$TF_PLAN_NAME" -input=false -no-color

  post_build:
    commands:
      - echo terraform plan completed on `date`

artifacts:
  files:
    - "$TF_PLAN_NAME"
  name: tf-plan
```

The plan is written to a file that is uploaded as an artifact to the CodePipeline project. The name of the file comes from an environment variable `TF_PLAN_NAME`.

## Invoking the Module

```terraform

module "aws-codebuild-pipeline-on-develop" {
  source = "../../aws-codepipeline-main"

  base_name           = "my-repo"
  project_description = "This project has been auto-generated by a Terraform example"


  terraform_version              = "0.13.5"    

  git_repo_name = "my-repo"
  git_https_url = "https://my-repo.codecommit"

  tags = {}

  git_branch = "develop"

  codebuild_role_arn = aws_iam_role.codebuild_role_example.arn
  codepipeline_role_arn = aws_iam_role.codepipeline_role_example.arn
}

``` 

### Variables

| Variable             | Description                                                                                 | Required | Example                             |
|----------------------|---------------------------------------------------------------------------------------------|---------:|-------------------------------------|
| base_name            | The base name of the set of resources to be created. This will be used to derive the resource names for AWS CodeBuild and AWS CodePipeline   |    yes   | `myrepo` |
| project_description  | A project description used to create the AWS CodeBuild/CodePipeline                         |    yes   | `CI/CD for my repo to non-production` |
| terraform_version    | The Terraform version to use.                                                               |    No. Default is `latest`.   | `0.13.5`                            |
| git_repo_name        | The AWS CodeCommit repo name                                                                |    yes   | `myrepo`                            |
| git_https_url    | The HTTPS clone URL for the AWS CodeCommit repo.                                                |    yes   | `https://git-codecommit.us-east-1.amazonaws.com/v1/repos/myrepo` |
| git_branch | The long-lived Git branch to build from                                                               |    No. Default is `master`    | `main`                              |
| codebuild_role_arn | The ARN of the role to use for each of the AWS CodeBuild resources.                           |    yes   | `arn:123`                           |
| codepipeline_role_arn     | The ARN of the role to use for the AWS CodePipeline resource.                          |    yes   | `arn:123`                           |
| tags                 | A map of the AWS tags to use                                                                |    Yes    | `{ "department"  = "engineering" }` |
| enable_manual_inspection | Enable the use of a CodePipeline stage that forces someone to look at the Terraform plan before applying |    Yes    | `true` |



# Notes

- Enable bucket versioning for storing the Terraform outputs
- Use HTTPS for the Git Clone URL instead of SSH
- CodePipeline needs read permissions to the AWS Code Commit repo
